name: Daily Dependency Check

on:
  schedule:
    - cron: '0 9 * * *'  # Runs at 9:00 AM UTC every day
  workflow_dispatch:  # Allows manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Check for dependency updates
        run: mvn versions:display-dependency-updates versions:display-plugin-updates

      - name: Generate update report
        run: |
          echo "# Dependency Update Report" > dependency-report.md
          echo "Generated: $(date)" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## Dependency Updates" >> dependency-report.md
          mvn versions:display-dependency-updates -DoutputFile=dep-updates.txt
          cat dep-updates.txt >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## Plugin Updates" >> dependency-report.md
          mvn versions:display-plugin-updates -DoutputFile=plugin-updates.txt
          cat plugin-updates.txt >> dependency-report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.md
          retention-days: 30

      - name: Create issue if updates available
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('dependency-report.md', 'utf8');

            // Check if there are actual updates (not just header)
            if (report.includes('->') || report.includes('available')) {
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'dependencies',
                state: 'open'
              });

              // Only create new issue if there isn't already an open one
              const existingIssue = issues.data.find(issue =>
                issue.title.includes('Dependency Updates Available')
              );

              if (!existingIssue) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `Dependency Updates Available - ${new Date().toISOString().split('T')[0]}`,
                  body: report,
                  labels: ['dependencies', 'automated']
                });
              } else {
                // Update existing issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: `## Update Check - ${new Date().toISOString()}\n\n${report}`
                });
              }
            }
