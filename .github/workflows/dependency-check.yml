name: Dependency Check & Security Scan

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger
  pull_request:
    paths:
      - 'pom.xml'

jobs:
  dependency-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'oracle'
          cache: maven

      - name: Display current dependencies
        run: mvn dependency:tree

      - name: Check for dependency updates
        run: mvn versions:display-dependency-updates

      - name: Check for plugin updates
        run: mvn versions:display-plugin-updates

      - name: Check for property updates
        run: mvn versions:display-property-updates

      - name: Generate dependency report
        run: mvn dependency:analyze

  security-scan:
    name: OWASP Dependency Security Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'oracle'
          cache: maven

      - name: Run OWASP Dependency-Check
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            -DsuppressionFile=owasp-suppressions.xml

      - name: Upload OWASP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: target/dependency-check-report.html

      - name: Upload to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: target/dependency-check-report.sarif
        continue-on-error: true

  outdated-dependencies:
    name: Report Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'oracle'
          cache: maven

      - name: Check for outdated dependencies
        run: |
          echo "# Dependency Update Report" > dependency-report.md
          echo "" >> dependency-report.md
          echo "## Dependency Updates Available" >> dependency-report.md
          echo '```' >> dependency-report.md
          mvn versions:display-dependency-updates | tee -a dependency-report.md
          echo '```' >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## Plugin Updates Available" >> dependency-report.md
          echo '```' >> dependency-report.md
          mvn versions:display-plugin-updates | tee -a dependency-report.md
          echo '```' >> dependency-report.md

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-update-report
          path: dependency-report.md

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('dependency-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
