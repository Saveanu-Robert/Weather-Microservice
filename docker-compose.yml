version: '3.8'

services:
  weather-service:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - APP_PORT=${APP_PORT:-8080}
    container_name: weather-microservice
    ports:
      - "${APP_PORT:-8080}:${APP_PORT:-8080}"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - WEATHER_API_KEY=${WEATHER_API_KEY}
      - SERVER_PORT=${APP_PORT:-8080}
      - DATABASE_URL=jdbc:h2:file:/data/weatherdb;AUTO_SERVER=FALSE
      - DATABASE_USERNAME=sa
      - DATABASE_PASSWORD=
      - TRACING_SAMPLE_RATE=${TRACING_SAMPLE_RATE:-1.0}
      - ZIPKIN_URL=http://zipkin:9411/api/v2/spans
    volumes:
      - weather-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:${APP_PORT:-8080}/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s
    networks:
      - weather-network
    depends_on:
      zipkin:
        condition: service_healthy

  zipkin:
    image: openzipkin/zipkin:latest
    container_name: zipkin
    ports:
      - "9411:9411"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:9411/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - weather-network

volumes:
  weather-data:
    driver: local

networks:
  weather-network:
    driver: bridge
